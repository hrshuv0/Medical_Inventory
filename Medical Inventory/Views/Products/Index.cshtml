@using Medical_Inventory.Models.ViewModel
@model ProductVm

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Product List</h1>

<div class="row">
    <div class="col">
        <a asp-action="Create" class="btn btn-primary">Create New</a>
    </div>
    <div class="col-4">
        @* <form asp-action="Index"> *@
        @*     <div class="row"> *@
        @*         <div class="col"> *@
        @*             <select asp-for="SelectedCategory" class="form-control text-center" asp-items="Model.CategoryList" id="filterId"> *@
        @*                 <option selected>All</option> *@
        @*             </select> *@
        @*         </div> *@
        @*         <div class="col"> *@
        @*             <input type="submit" value="filter"/> *@
        @*         </div> *@
        @*     </div> *@
        @* *@
        @* </form> *@

        <div>
            <select asp-for="SelectedCategory" class="form-control text-center" asp-items="Model.CategoryList" id="filterId" name="filterId">
                --<option selected>All</option>--
            </select>

        </div>

    </div>
    <div class="col-4">
        <form asp-controller="Products" asp-action="Index">
            <p>
                <input type="text" name="SearchString"/>
                <input type="submit" value="Search"/>
            </p>
        </form>

    </div>
</div>
<table class="table table-bordered" id="tableId">
    <thead>
    <tr>
        <th>
            Name
        </th>
        <th>
            Strength
        </th>
        <th>
            Generic
        </th>
        <th>
            Category
        </th>
        <th></th>
    </tr>
    </thead>
    <tbody>
    @foreach (var item in Model.Products!)
    {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Name)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Strength)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Generic)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Category.Name)
            </td>
            <td>
                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-secondary" style="width: 100px">Edit</a>
                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info" style="width: 100px">Details</a>
                <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-warning" style="width: 100px">Delete</a>
            </td>
        </tr>
    }
    </tbody>
</table>

@section Scripts
{
    <script>
    
    $("#filterId").change(function (){
        
        let categoryId = document.getElementById('filterId').value;
        console.log(categoryId);
        
        $.ajax({
            url:"Products/GetAll?id="+categoryId,
            method:"GET",
            success:function (data){
                updateTable(data.data);
                // alert(data.data[0])
                // console.log(data.data)
                
            }
        });
        
        function updateTable(data) {
            let table = document.getElementById('#tableId');
            let tableBody = document.querySelector('#tableId > tbody');
            // console.log(tableBody);
            
            //console.log(data);
            
            const request = new XMLHttpRequest();
            
            try {
                
               for (let i = 0; i < data.length; i++)
               {
                   console.log(data[i].name);
               }
                             
              // data.forEach((row) =>{
              //     console.log(row)
              // });
                            
              
              while (tableBody.firstChild){
                  tableBody.removeChild(tableBody.firstChild);
              }
              
              data.forEach((row) =>{
                  const tr = document.createElement("tr");
                  
                  
                  let td = document.createElement("td");
                  td.textContent = row.name;
                  tr.appendChild(td);
                  
                  td = document.createElement("td");
                  td.textContent = row.strength;
                  tr.appendChild(td);
                  
                  td = document.createElement("td");
                  td.textContent = row.generic;
                  tr.appendChild(td);
                  
                  td = document.createElement("td");
                  td.textContent = row.category.name;
                  tr.appendChild(td);
                  
                  let action = `<div class="w-75 btn-group" role="group">
                                                        <a href="/Products/Edit?id=${row.id}"
                                                           class="btn btn-secondary m-2">
                                                            <i class="bi bi-pencil-square"></i> Edit
                                                        </a>
                                                            
                                                        <a href="/Products/Details?id=${row.id}"
                                                                class="btn btn-info m-2">
                                                             <i class="bi bi-pencil-square"></i> Details
                                                        </a>

                                                        <a href="/Products/Delete?id=${row.id}"
                                                            class="btn btn-warning m-2"
                                                            <i class="bi bi-trash-fill"></i> Delete
                                                        </a>
                                                    </div>`;
                  
                  td = document.createElement("td");
                  td.innerHTML = action;
                  tr.appendChild(td);
                  
                  tableBody.appendChild(tr);
                  
                  // console.log(tr);
                  // console.log(row.name);
                  // console.log(row.strength);
                  
              });
              
             console.log("done");
              
            }
            catch(e){
                    console.log("failed "+ e)
                }
            
           
            }
                    
        });
    
    </script>

}